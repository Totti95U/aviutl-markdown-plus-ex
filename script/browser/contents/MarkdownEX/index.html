<!DOCTYPE html>
<html lang="ja">
<style>
html, body {
  margin: 0;
  padding: 0;
}
body {
  margin-top: 1px;
  overflow: hidden;
}
</style>
<link rel="stylesheet" id="markdown-style" href="./css/markdown/github-markdown.css">
<link rel="stylesheet" id="hljs-style" href="./css/hljs/github.css">
<div class="markdown-body"></div>
<script src="./marked.min.js"></script>
<script src="./highlight.min.js"></script>
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
  },
};
</script>
<script id="MathJax-script" src="./mathjax/tex-chtml.js"></script>
<script type="module">
marked.setOptions({
  langPrefix: '',
  highlight: (code, lang) => {
    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
    return hljs.highlight(code, {language}).value;
  },
});

const linkPrefix = `${location.protocol}//${location.host}`
const parseParam = param => {
  const parsed = {};

  let next = param.indexOf('/');
  if (next == -1) return null;
  parsed.scale = parseInt(param.substring(0, next), 10) / 100;

  let prev = next + 1;
  next = param.indexOf('/', prev);
  if (next == -1) return null;
  parsed.markdownStyle = `${linkPrefix}/css/markdown/${param.substring(prev, next)}.css`;

  prev = next + 1;
  next = param.indexOf('/', prev);
  if (next == -1) return null;
  parsed.hljsStyle = `${linkPrefix}/css/hljs/${param.substring(prev, next)}.css`;

  parsed.markdown = param.substring(next + 1);
  return parsed;
};

const markdownStyle = document.getElementById('markdown-style');
const hljsStyle = document.getElementById('hljs-style');
const elem = document.querySelector('div.markdown-body');
let current = '';
AviUtlBrowser.registerRenderer(async params => {
  const param = parseParam(params.param);
  if (param == null) {
    throw new Error('invalid parameter');
  }

  elem.style.zoom = param.scale;
  if (markdownStyle.href !== param.markdownStyle) {
    markdownStyle.href = param.markdownStyle;
  }
  if (hljsStyle.href !== param.hljsStyle) {
    hljsStyle.href = param.hljsStyle;
  }

  if (current == param.markdown) {
    return '';
  }
  current = param.markdown;
  elem.innerHTML = marked(current);
  MathJax.typeset();
  return '';
});
</script>
</html>
